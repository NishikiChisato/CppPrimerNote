# 网络编程

- [网络编程](#网络编程)
  - [基本概念](#基本概念)
  - [主要函数](#主要函数)


## 基本概念

主机 `host` 指计算机设备，这包括客户端和服务器或者其他网络设备，主机可以通过主机名（也叫域名） `host name` 或者 `IP` 地址 `IP address` 进行标识。每台主机都有本地域名 `localhost`，用 `IP` 地址 `127.0.0.1` 进行标识，这被称为回环地址 `loopback address`

服务 `server` 指运行在主机上的网络服务或者应用进程，通过端口号 `port` 进行标识。因此，通过 `IP` 和 `port` 便可以在互联网中**确定某台主机的某个进程**

> 注：特定的主机和服务名（端口号）可能对应多个网络地址（`<IP, port>` 对）。比如，一台主机下可能会有多个网络接口，那么每个接口都会有一个独特的 `IP` 地址；或者一台主机上运行多个服务，那么每个服务都会有一个端口号。这便是为什么 `getaddrinfo` 函数会返回一个网络地址链表的原因

`IP` 地址是一个 `32` 位无符号整数，用**大端字节序**存储，定义如下：

```c
struct in_addr {
    uint32_t s_addr;//big-endian
}
```

网络字节序 `network byte order` **固定**为大端字节序，而主机字节序 `host byte order` 则不确定（但通常为小端字节序），以下四个函数提供二者之间的转换：

```c
#include <arpa/inet.h>

uint32_t htonl(uint32_t hostlong);
uint16_t htons(uint16_t hostshort);

uint32_t ntohl(uint32_t hostlong);
uint16_t ntohs(uint16_t hostshort);
```

这个函数有 `16` 位的版本，也有 `32` 位的版本，但没有 `64` 位的版本

`IP` 地址通常可以用点分十进制 `detted-decimal notation` 表示，以下两个函数用于将 `16` 进制的 `IP` 地址转化为点分十进制表示：

```c
#include <arpa/inet.h>

//success return 1, sec illeague return 0, another error return -1
int inet_pton(AF_INET, const char* src, void* dst);

//if success, will pointe to string which is detted-decimal notation
const char* inet_ntop(AF_INET, const char* src, socklen_t size);
```

这些函数中 `n` 代表网络 `network`，`p` 代表表示方法 `presentation`；`AF_INET` 表示 `IPv4`，`AF_INET6` 表示 `IPv6`

`inet_pton` 将一个 `src` 指向的点分十进制字符串转化为二进制网络字节顺序的 `IP` 地址；`inet_ntop` 将一个 `src` 指向的二进制网络字节顺序的 `IP` 地址转化为点分十进制表示的字符串，并以 `NULL` 结尾

* 二进制转十进制：`0x8002c2f2 -> 128.2.194.242`

套接字 `socket` 是连接的一个**端点**，每个套接字都有一个**套接字地址** `socket address` ，用 `address : port` 表示

当客户端请求一个连接时，客户端套接字地址当中的端口号为内核分配的临时端口 `ephemeral port`，而服务器的端口号则为知名端口，`Web` 服务器为 `80`，邮件服务器为 `25`

一个连接有两端的套接字地址唯一确定，这被称为套接字对，即：`(client_address : client_port, server_address : server_port)`

对于 `Linux` 内核而言，套接字是通信的一个端点；对于应用级程序员而言，套接字则是一个有着相应文件描述符的文件

> `Linux` 当中每个文件都有一个类型：
> * `regular file` 普通文件：应用程序会区分文本文件 `text file` 和二进制文件 `binary file`，但对内核而言二者没有区别
> 
> * `diretcory` 目录：目录是包含一组链接 `link` 的文件，每个链接既可以映射到一个文件，也可以映射到目录。一个目录至少包含两个文件：`.` 对于自身的引用和 `..` 对于父目录的引用
> 
> * `socket` 套接字：用于网络编程；`block device` 块设备；`symbolic link` 符合链接，也就是软链接；命名通道 `named pipe`

一个套接字地址存放在类型为 `sockaddr_in` 的结构体中，此结构体大小**固定为 `16` 字节**，`sin_family` 表示 `AF_INET`，`sin_port` 是一个 `16` 位的端口号，`sin_addr` 是一个 `32` 位的 `IP` 地址，`sin_zero` 填充剩余字节以满足总大小为 `16` 的要求

```c
struct sockaddr_in {
    uint16_t    sin_family;
    uint16_t    sin_port;
    uint32_t    sin_addr;
    unsigned char sin_zero[8];
};
```

在老的代码中，由于没有 `void*` 这个通用指针，因此我们需要一个通用的指针来指向不同协议的套接字，这个问题的解决是将 `sockaddr` 结构体指针强制转化成一个通用的结构体指针（这也是为什么这个结构体要强制 `16` 字节对齐的原因）：

```c
struct sockaddr {
    uint16_t    sa_family;
    char        sa_data[14];
};
//usually use SA instead of struct sockaddr
typedef struct sockaddr SA;
```

## 主要函数

 

